
stages:
  - publish
  - build
  - deploy

dotnet:
  stage: publish
  image: microsoft/dotnet:2.1-sdk
  script:
    - dotnet publish -c release -o dist
  artifacts:
    name: wechat-gateway-($CI_PIPELINE_ID)
    paths:
      - dist

docker:
  stage: build
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker build --pull -t $CI_REGISTRY_IMAGE:$CI_PIPELINE_ID .
    - docker tag $CI_REGISTRY_IMAGE:$CI_PIPELINE_ID $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:$CI_PIPELINE_ID
    - docker push $CI_REGISTRY_IMAGE:latest
  dependencies:
    - dotnet
